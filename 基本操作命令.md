手动加锁

```shell
# 全库加读锁 
flush tables with read lock;（此操作会给全库加读锁，对库进行写操作）
unlock tables;(释放锁)

# innodb引擎由于多版本控制的原因，默认读操作不加锁，手动加锁如下
for update（写锁） 和 lock in share mode（读锁）
select * from t1 for update；加写锁
select * from t1 lock in share mode；加读锁
```





```shell
# 查看当前运行的事物
select  timediff(sysdate(),trx_started) timediff,sysdate(),trx_started,id,USER,DB,COMMAND,STATE,trx_state,trx_query from information_schema.processlist,information_schema.innodb_trx  where trx_mysql_thread_id=id;

# 查看超过60秒的事物
select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))>60；

# 查看元锁情况
select * from information_schema.processlist where state='Waiting for table metadata lock';

# 查看锁冲突详情（锁源头，等待的事物详情）
select t.trx_id blocking_trx_id,
       t.trx_mysql_thread_id blocking_thread,
       t.trx_query blocking_query,
       r.trx_id waiting_trx_id,
       r.trx_mysql_thread_id waiting_thread,
       r.trx_query waiting_query
from information_schema.innodb_lock_waits w inner join information_schema.innodb_trx t on t.trx_id=w.blocking_trx_id inner join information_schema.innodb_trx r on r.trx_id=w.requesting_trx_id;

# 查看锁冲突的情况 (分组后的锁源头及数量)
select blocking_trx_id, count(blocking_trx_id) as countnum from (select a.trx_id,a.trx_state,b.requesting_trx_id,b.blocking_trx_id from information_schema.innodb_lock_waits as  b left join information_schema.innodb_trx as a on a.trx_id=b.requesting_trx_id) as t1 group by blocking_trx_id order by countnum  desc;

# 查看锁的源头ID
select id from information_schema.processlist,information_schema.innodb_trx  where trx_mysql_thread_id=id and trx_id in (select blocking_trx_id from (select blocking_trx_id, count(blocking_trx_id) as countnum from (select a.trx_id,a.trx_state,b.requesting_trx_id,b.blocking_trx_id from information_schema.innodb_lock_waits as  b left join information_schema.innodb_trx as a on a.trx_id=b.requesting_trx_id) as t1 group by blocking_trx_id order by  countnum desc limit 1) c) ;
```

慢日志切分

```shell
1 重命名原先满日志文件
mv dataslow.log dataslow.log

2 数据库中刷新slow log
flush slow logs;

#!/bin/bash
DATE=`date +%Y%m%d`
slowlog=
user=
passwd=
mv $slowlog $slowlog$DATE
echo 'flush slow logs;' | mysql -u$user -p$passwd
```

| 序号 | 命令                       | 作用                               | --   |
| ---- | -------------------------- | ---------------------------------- | ---- |
| 1    | *pt-duplicate-key-checker* | 列出并删除重复的索引和外键         |      |
| 2    | *pt-online-schema-change*  | 在线修改表结构                     | 操作 |
| 3    | *pt-query-advisor*         | 分析查询语句，并给出建议，有*bug*  |      |
| 4    | *pt-show-grants*           | 规范化和打印权限                   |      |
| 5    | *pt-upgrade*               | 在多个服务器上执行查询，并比较不同 |      |
| 6    | *pt-index-usage*           | 分析日志中索引使用情况，并出报告   |      |
| 7    | *pt-pmp*                   | 为查询结果跟踪，并汇总跟踪结果     |      |
| 8    | *pt-visual-explain*        | 格式化执行计划                     |      |
| 9    | *pt-table-usage*           | 分析日志中查询并分析表使用情况     |      |
| 10   | *pt-config-diff*           | 比较配置文件和参数                 |      |
| 11   | *pt-mysql-summary*         | 对*mysql*配置和*status*进行汇总    |      |
| 12   | *pt-variable-advisor*      | 分析参数，并提出建议               |      |
| 13   | *pt-deadlock-logger*       | 提取和记录*mysql*死锁信息          |      |
| 14   | *pt-fk-error-logger*       | 提取和记录外键信息                 |      |
| 15   | *pt-mext*                  | 并行查看*status*样本信息           |      |
| 16   | *pt-query-digest*          | 分析查询日志，并产生报告           | 操作 |
| 17   | *pt-trend*                 | 按照时间段读取*slow*日志信息       |      |
| 18   | *pt-heartbeat*             | 监控*mysql*复制延迟                |      |
| 19   | *pt-slave-delay*           | 设定从落后主的时间                 |      |
| 20   | *pt-slave-find*            | 查找和打印所有*mysql*复制层级关系  |      |
| 21   | *pt-slave-restart*         | 监控*salve*错误，并尝试重启*salve* |      |
| 22   | *pt-table-checksum*        | 校验主从复制一致性                 | 操作 |
| 23   | *pt-table-sync*            | 高效同步表数据                     |      |
| 24   | *pt-diskstats*             | 查看系统磁盘状态                   |      |
| 25   | *pt-fifo-split*            | 模拟切割文件并输出                 |      |
| 26   | *pt-summary*               | 收集和显示系统概况                 |      |
| 27   | *pt-stalk*                 | 出现问题时，收集诊断数据           |      |
| 28   | *pt-sift*                  | 浏览由*pt-stalk*创建的文件         |      |
| 29   | *pt-ioprofile*             | 查询进程*IO*并打印一个*IO*活动表   |      |
| 30   | *pt-archiver*              | 将表数据归档到另一个表或文件中     | 操作 |
| 31   | *pt-find*                  | 查找表并执行命令                   |      |
| 32   | *pt-kill*                  | *Kill*掉符合条件的*sql*            | 操作 |
| 33   | *pt-align*                 | 对齐其他工具的输出                 |      |
| 34   | *pt-fingerprint*           | 将查询转成密文                     |      |



工具类别

工具命令

工具作用

备注

开发类

pt-duplicate-key-checker

列出并删除重复的索引和外键


pt-online-schema-change

在线修改表结构


pt-query-advisor

分析查询语句，并给出建议，有bug

已废弃

pt-show-grants

规范化和打印权限


pt-upgrade

在多个服务器上执行查询，并比较不同


性能类

pt-index-usage

分析日志中索引使用情况，并出报告


pt-pmp

为查询结果跟踪，并汇总跟踪结果


pt-visual-explain

格式化执行计划


pt-table-usage

分析日志中查询并分析表使用情况

pt 2.2新增命令

配置类

pt-config-diff

比较配置文件和参数


pt-mysql-summary

对mysql配置和status进行汇总


pt-variable-advisor

分析参数，并提出建议


监控类

pt-deadlock-logger

提取和记录mysql死锁信息


pt-fk-error-logger

提取和记录外键信息


pt-mext

并行查看status样本信息


pt-query-digest

分析查询日志，并产生报告

常用命令

pt-trend

按照时间段读取slow日志信息

已废弃

复制类

pt-heartbeat

监控mysql复制延迟


pt-slave-delay

设定从落后主的时间


pt-slave-find

查找和打印所有mysql复制层级关系


pt-slave-restart

监控salve错误，并尝试重启salve


pt-table-checksum

校验主从复制一致性


pt-table-sync

高效同步表数据


系统类

pt-diskstats

查看系统磁盘状态


pt-fifo-split

模拟切割文件并输出


pt-summary

收集和显示系统概况


pt-stalk

出现问题时，收集诊断数据


pt-sift

浏览由pt-stalk创建的文件

pt 2.2新增命令

pt-ioprofile

查询进程IO并打印一个IO活动表

pt 2.2新增命令

实用类

pt-archiver

将表数据归档到另一个表或文件中


pt-find

查找表并执行命令


pt-kill

Kill掉符合条件的sql

常用命令
pt-align

对齐其他工具的输出

pt 2.2新增命令

pt-fingerprint

将查询转成密文

pt 2.2新增命令
--------------------- 
作者：yumushui 
来源：CSDN 
原文：https://blog.csdn.net/yumushui/article/details/42919601 
版权声明：本文为博主原创文章，转载请附上博文链接！